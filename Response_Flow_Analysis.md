# ğŸ”„ å“åº”ç”Ÿæˆå®Œæ•´è·¯å¾„åˆ†æ

## å“åº”ç”Ÿæˆçš„ä¸‰ä¸ªå±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 1 å±‚ï¼šMCPToolCallAgent.act()                             â”‚
â”‚  ã€æ ¸å¿ƒå“åº”ç”Ÿæˆã€‘                                              â”‚
â”‚  - æ–‡ä»¶ï¼šmcp_toolcall_agent.py:383-396                       â”‚
â”‚  - ä½œç”¨ï¼šè°ƒç”¨ OpenAI LLM ç”Ÿæˆè‡ªç„¶è¯­è¨€ç­”æ¡ˆ                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 2 å±‚ï¼šagent_orchestrator._run_single()                    â”‚
â”‚  ã€å“åº”æå–ä¸åŒ…è£…ã€‘                                            â”‚
â”‚  - æ–‡ä»¶ï¼šagent_orchestrator.py:83-128                        â”‚
â”‚  - ä½œç”¨ï¼šä» agent.messages æå–æœ€ç»ˆç­”æ¡ˆå¹¶ yield               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 3 å±‚ï¼šqa_sse.py generate()                               â”‚
â”‚  ã€SSE æ ¼å¼åŒ–ä¸ä¼ è¾“ã€‘                                          â”‚
â”‚  - æ–‡ä»¶ï¼šqa_sse.py:178-194                                   â”‚
â”‚  - ä½œç”¨ï¼šæ ¼å¼åŒ–ä¸º SSE æ ¼å¼å¹¶é€šè¿‡ HTTP æµå¼ä¼ è¾“                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## è¯¦ç»†ä»£ç è·¯å¾„

### ğŸ¯ ç¬¬ 1 å±‚ï¼šæ ¸å¿ƒå“åº”ç”Ÿæˆï¼ˆMCPToolCallAgentï¼‰

**æ–‡ä»¶**ï¼š`mcp_toolcall_agent.py:383-396`

```python
async def act(self) -> str:
    if has_summary_request:
        # ğŸ“ è¿™é‡Œæ˜¯æœ€æ ¸å¿ƒçš„å“åº”ç”Ÿæˆä½ç½®ï¼
        
        # 1. æ„å»ºç²¾ç®€ä¸Šä¸‹æ–‡
        filtered_messages = [
            {"role": "user", "content": "åŸå§‹æŸ¥è¯¢"},
            {"role": "assistant", "content": "æ£€ç´¢åˆ°çš„ä¿¡æ¯æ‘˜è¦"},
            {"role": "user", "content": "æ ¹æ®ä¸Šè¿°ä¿¡æ¯å›ç­”é—®é¢˜..."}
        ]
        
        # 2. ğŸ”¥ è°ƒç”¨ OpenAI LLM ç”Ÿæˆå“åº”
        completion = self._client.chat.completions.create(
            model=self.model,
            messages=filtered_messages,
            max_completion_tokens=4096
        )
        
        # 3. æå–å“åº”å†…å®¹
        response_content = completion.choices[0].message.content.strip()
        # response_content = "å¾ªç¯æ°´å…»æ®–ç³»ç»Ÿæ˜¯ä¸€ç§å…ˆè¿›çš„æ°´äº§å…»æ®–æŠ€æœ¯..."
        
        # 4. ä¿å­˜åˆ°æ¶ˆæ¯å†å²
        self.memory.add(Message.assistant(response_content))
        
        # 5. è®¾ç½®å®ŒæˆçŠ¶æ€
        self.state = AgentState.FINISHED
        
        # 6. è¿”å›å“åº”å†…å®¹
        return response_content  # ğŸ“¤ è¿™å°±æ˜¯æœ€ç»ˆç­”æ¡ˆï¼
```

**å…³é”®ç‚¹**ï¼š
- âœ… è¿™é‡Œç”Ÿæˆçš„æ˜¯**è‡ªç„¶è¯­è¨€ç­”æ¡ˆ**
- âœ… ä¸å¸¦ `tools` å‚æ•°ï¼Œå¼ºåˆ¶ LLM ç”Ÿæˆæ–‡æœ¬
- âœ… ä½¿ç”¨ç²¾ç®€ä¸Šä¸‹æ–‡ï¼ˆé¿å… token æº¢å‡ºï¼‰

---

### ğŸ¯ ç¬¬ 2 å±‚ï¼šå“åº”æå–ä¸åŒ…è£…ï¼ˆagent_orchestratorï¼‰

**æ–‡ä»¶**ï¼š`agent_orchestrator.py:83-128`

```python
def _run_single(query: str, cfg) -> Generator[Dict[str, Any], None, str]:
    while step_index < max_steps and agent.state != AgentState.FINISHED:
        step_index += 1
        result = asyncio.run(agent.step())  # è¿™é‡Œè°ƒç”¨ think() + act()
        
        # è·å–æœ€æ–°çš„æ¶ˆæ¯
        if agent.messages:
            last_msg = agent.messages[-1]
            
            # ğŸ“ æ£€æµ‹åˆ°æœ€ç»ˆç­”æ¡ˆ
            if last_msg.role == "assistant" and last_msg.content:
                content = last_msg.content
                
                # æ£€æŸ¥æ˜¯å¦æ˜¯æœ€ç»ˆç­”æ¡ˆ
                if agent.state == AgentState.FINISHED:
                    final_answer = content  # ä¿å­˜æœ€ç»ˆç­”æ¡ˆ
                    
                    # ğŸ“¤ ç«‹å³ yield æœ€ç»ˆç­”æ¡ˆ
                    yield {
                        "type": "final_answer",
                        "step": step_index,
                        "content": content
                    }
    
    # å¾ªç¯ç»“æŸåï¼Œå†æ¬¡ yield æœ€ç»ˆç­”æ¡ˆï¼ˆåŒ…è£…ä¸º status: "final"ï¼‰
    if final_answer:
        # ğŸ“¤ è¿™æ˜¯è¿”å›ç»™ SSE çš„æœ€ç»ˆæ ¼å¼
        yield {
            "status": "final",
            "answer": final_answer  # ğŸ“ è¿™é‡Œï¼
        }
    else:
        yield {
            "status": "final",
            "answer": "æŠ±æ­‰ï¼Œæœªèƒ½ç”Ÿæˆæœ‰æ•ˆå›ç­”ã€‚"
        }
```

**å…³é”®ç‚¹**ï¼š
- âœ… ä» `agent.messages[-1]` æå–æœ€ç»ˆç­”æ¡ˆ
- âœ… ä¸¤æ¬¡ yieldï¼š
  - ç¬¬ 1 æ¬¡ï¼š`{"type": "final_answer", "content": "..."}`ï¼ˆå¯é€‰ï¼‰
  - ç¬¬ 2 æ¬¡ï¼š`{"status": "final", "answer": "..."}`ï¼ˆå¿…éœ€ï¼‰

---

### ğŸ¯ ç¬¬ 3 å±‚ï¼šSSE æ ¼å¼åŒ–ä¸ä¼ è¾“ï¼ˆqa_sseï¼‰

**æ–‡ä»¶**ï¼š`qa_sse.py:178-194`

```python
def generate():
    # éå† agent_function çš„æ‰€æœ‰ yield
    for i, data in enumerate(agent_function(query, config)):
        if not isinstance(data, dict):
            continue
        
        # ğŸ“ å¤„ç†æœ€ç»ˆç­”æ¡ˆ
        if data.get("status") == "final":
            # æ„å»º SSE æ¶ˆæ¯
            final_message = {
                "session_id": session_id,
                "timestamp": time.strftime('%H:%M:%S'),
                "agent_type": agent_type,
                "message_id": str(uuid.uuid4()),
                "content": "æŸ¥è¯¢å¤„ç†å®Œæˆï¼Œè¿”å›æœ€ç»ˆç­”æ¡ˆ",
                "data": {
                    "status": "completed",
                    "answer": data.get("answer", "")  # ğŸ“ ä»è¿™é‡Œå–å‡ºç­”æ¡ˆ
                }
            }
            
            # æ ¼å¼åŒ–ä¸º JSON
            json_data = json.dumps(final_message, ensure_ascii=False)
            
            # ğŸ“¤ é€šè¿‡ SSE å‘é€ç»™å®¢æˆ·ç«¯
            yield sse_format(json_data)
            # å®é™…å‘é€ï¼š
            # data: {"session_id":"xxx","data":{"status":"completed","answer":"å¾ªç¯æ°´å…»æ®–ç³»ç»Ÿæ˜¯ä¸€ç§..."}}
            
            final_sent = True
            break
```

**å…³é”®ç‚¹**ï¼š
- âœ… å°†ç­”æ¡ˆåŒ…è£…åœ¨ `data.answer` å­—æ®µä¸­
- âœ… ä½¿ç”¨ `sse_format()` æ ¼å¼åŒ–ä¸º SSE æ ¼å¼
- âœ… é€šè¿‡ Flask `yield` æµå¼ä¼ è¾“

---

## å®Œæ•´å“åº”æµè½¬ç¤ºä¾‹

### ç”¨æˆ·æŸ¥è¯¢ï¼š"ä»‹ç»å¾ªç¯æ°´å…»æ®–ç³»ç»Ÿçš„åŸç†"

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 1ï¼šMCPToolCallAgent.act()                                â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ filtered_messages = [                                         â”‚
â”‚     {"role": "user", "content": "ä»‹ç»å¾ªç¯æ°´å…»æ®–ç³»ç»Ÿçš„åŸç†"},    â”‚
â”‚     {"role": "assistant", "content": "æ£€ç´¢åˆ°çš„ä¿¡æ¯ï¼š\nå¾ªç¯æ°´..."},â”‚
â”‚     {"role": "user", "content": "æ ¹æ®ä¸Šè¿°ä¿¡æ¯å›ç­”..."}         â”‚
â”‚ ]                                                             â”‚
â”‚                                                               â”‚
â”‚ completion = openai.chat.completions.create(...)             â”‚
â”‚                                                               â”‚
â”‚ response_content = "å¾ªç¯æ°´å…»æ®–ç³»ç»Ÿæ˜¯ä¸€ç§å…ˆè¿›çš„æ°´äº§å…»æ®–æŠ€æœ¯ï¼Œå…¶æ ¸å¿ƒåŸç†åŒ…æ‹¬..." â”‚
â”‚                                                               â”‚
â”‚ return response_content  â† ğŸ“¤ ç¬¬1å±‚è¾“å‡º                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 2ï¼šagent_orchestrator._run_single()                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ agent.messages[-1] = Message(                                â”‚
â”‚     role="assistant",                                         â”‚
â”‚     content="å¾ªç¯æ°´å…»æ®–ç³»ç»Ÿæ˜¯ä¸€ç§å…ˆè¿›çš„æ°´äº§å…»æ®–æŠ€æœ¯..."           â”‚
â”‚ )                                                             â”‚
â”‚                                                               â”‚
â”‚ final_answer = "å¾ªç¯æ°´å…»æ®–ç³»ç»Ÿæ˜¯ä¸€ç§å…ˆè¿›çš„æ°´äº§å…»æ®–æŠ€æœ¯..."       â”‚
â”‚                                                               â”‚
â”‚ yield {                                                       â”‚
â”‚     "status": "final",                                        â”‚
â”‚     "answer": final_answer                                    â”‚
â”‚ }  â† ğŸ“¤ ç¬¬2å±‚è¾“å‡º                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 3ï¼šqa_sse.generate()                                     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ for data in agent_function(query, config):                   â”‚
â”‚     if data.get("status") == "final":                         â”‚
â”‚         final_message = {                                     â”‚
â”‚             "session_id": "xxx",                              â”‚
â”‚             "timestamp": "14:30:25",                          â”‚
â”‚             "content": "æŸ¥è¯¢å¤„ç†å®Œæˆï¼Œè¿”å›æœ€ç»ˆç­”æ¡ˆ",             â”‚
â”‚             "data": {                                         â”‚
â”‚                 "status": "completed",                        â”‚
â”‚                 "answer": "å¾ªç¯æ°´å…»æ®–ç³»ç»Ÿæ˜¯ä¸€ç§å…ˆè¿›çš„æ°´äº§å…»æ®–æŠ€æœ¯..." â”‚
â”‚             }                                                 â”‚
â”‚         }                                                     â”‚
â”‚                                                               â”‚
â”‚         yield sse_format(json_data)  â† ğŸ“¤ ç¬¬3å±‚è¾“å‡ºï¼ˆSSEæ ¼å¼ï¼‰  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯æ¥æ”¶åˆ°çš„ SSE æ•°æ®                                        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ data: {"session_id":"xxx","timestamp":"14:30:25","content":"æŸ¥è¯¢å¤„ç†å®Œæˆï¼Œè¿”å›æœ€ç»ˆç­”æ¡ˆ","data":{"status":"completed","answer":"å¾ªç¯æ°´å…»æ®–ç³»ç»Ÿæ˜¯ä¸€ç§å…ˆè¿›çš„æ°´äº§å…»æ®–æŠ€æœ¯ï¼Œå…¶æ ¸å¿ƒåŸç†åŒ…æ‹¬ç‰©ç†è¿‡æ»¤ã€ç”Ÿç‰©è¿‡æ»¤ã€ç´«å¤–çº¿æ¶ˆæ¯’ç­‰ç¯èŠ‚..."}} â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å“åº”å†…å®¹çš„æ¥æº

### ğŸ“ æœ€æ ¸å¿ƒçš„ä½ç½®

```python
# æ–‡ä»¶ï¼šmcp_toolcall_agent.py:383-388
completion = self._client.chat.completions.create(
    model=self.model,                      # "gpt-4o-mini"
    messages=filtered_messages,            # ç²¾ç®€ä¸Šä¸‹æ–‡
    max_completion_tokens=4096
)
response_content = completion.choices[0].message.content.strip()
```

**è¿™é‡Œå°±æ˜¯å“åº”çš„å”¯ä¸€æ¥æºï¼**

æ‰€æœ‰çš„è‡ªç„¶è¯­è¨€ç­”æ¡ˆéƒ½æ˜¯ä»è¿™é‡Œç”Ÿæˆçš„ï¼š
- âœ… OpenAI LLM æ ¹æ®æ£€ç´¢ç»“æœå’ŒæŸ¥è¯¢ç”Ÿæˆ
- âœ… ä¸ä½¿ç”¨ `tools` å‚æ•°ï¼ˆå¼ºåˆ¶æ–‡æœ¬ç”Ÿæˆï¼‰
- âœ… ä½¿ç”¨ç²¾ç®€ä¸Šä¸‹æ–‡ï¼ˆåŸå§‹æŸ¥è¯¢ + æ£€ç´¢ç»“æœæ‘˜è¦ï¼‰

---

## å“åº”ç±»å‹æ€»ç»“

ç³»ç»Ÿä¼šç”Ÿæˆå¤šç§å“åº”ç±»å‹ï¼Œé€šè¿‡ SSE æµå¼ä¼ è¾“ï¼š

### 1. å·¥å…·è°ƒç”¨å“åº”
```json
{
    "type": "tool_call",
    "step": 1,
    "tool_name": "retrieve",
    "content": "è°ƒç”¨å·¥å…·: retrieve"
}
```

### 2. æ€è€ƒè¿‡ç¨‹å“åº”ï¼ˆå¯é€‰ï¼‰
```json
{
    "type": "thinking",
    "step": 2,
    "content": "åˆ†ææ£€ç´¢ç»“æœ..."
}
```

### 3. æœ€ç»ˆç­”æ¡ˆå“åº” â­
```json
{
    "status": "final",
    "answer": "å¾ªç¯æ°´å…»æ®–ç³»ç»Ÿæ˜¯ä¸€ç§å…ˆè¿›çš„æ°´äº§å…»æ®–æŠ€æœ¯..."
}
```

### 4. é”™è¯¯å“åº”
```json
{
    "status": "error",
    "reason": "å·¥å…·è°ƒç”¨å¤±è´¥: ..."
}
```

---

## å“åº”ç”Ÿæˆæ—¶æœº

### ä»€ä¹ˆæ—¶å€™ç”Ÿæˆæœ€ç»ˆå“åº”ï¼Ÿ

```python
# æ¡ä»¶1ï¼šå·¥å…·è°ƒç”¨è¾¾åˆ°é™åˆ¶ï¼ˆ3è½®ï¼‰
if tool_call_count >= 3:
    # å¼ºåˆ¶ç”Ÿæˆæ€»ç»“
    self.memory.add(Message.user("è¯·æ ¹æ®ä¸Šè¿°æ£€ç´¢åˆ°çš„ä¿¡æ¯..."))
    return True  # è§¦å‘ act() ç”Ÿæˆå“åº”

# æ¡ä»¶2ï¼šæ£€æµ‹åˆ°æ€»ç»“è¯·æ±‚
if has_summary_request:
    # ç”Ÿæˆå“åº”
    response_content = openai.chat.completions.create(...)
    return response_content

# æ¡ä»¶3ï¼šLLM ä¸»åŠ¨å†³å®šä¸å†è°ƒç”¨å·¥å…·
if not tool_calls and content:
    # LLM ç›´æ¥ç»™å‡ºç­”æ¡ˆ
    self.memory.add(Message.assistant(content))
    self.state = AgentState.FINISHED
    return False
```

---

## å…³é”®ä»£ç ä½ç½®é€ŸæŸ¥è¡¨

| åŠŸèƒ½ | æ–‡ä»¶ | è¡Œæ•° | è¯´æ˜ |
|-----|------|------|------|
| **å“åº”ç”Ÿæˆï¼ˆæ ¸å¿ƒï¼‰** | `mcp_toolcall_agent.py` | 383-396 | OpenAI LLM ç”Ÿæˆè‡ªç„¶è¯­è¨€ |
| å“åº”æå– | `agent_orchestrator.py` | 83-89 | ä» messages æå–ç­”æ¡ˆ |
| å“åº”åŒ…è£… | `agent_orchestrator.py` | 123-128 | åŒ…è£…ä¸º `{"status": "final", "answer": "..."}` |
| SSE æ ¼å¼åŒ– | `qa_sse.py` | 178-194 | æ ¼å¼åŒ–ä¸º SSE å¹¶ä¼ è¾“ |
| å·¥å…·è°ƒç”¨æ£€æµ‹ | `mcp_toolcall_agent.py` | 447-449 | æ£€æµ‹æ•°æ®è·å–å·¥å…· |
| æ€»ç»“è¯·æ±‚ç”Ÿæˆ | `mcp_toolcall_agent.py` | 165-168 | å¼ºåˆ¶ç”Ÿæˆæ€»ç»“ |

---

## æ€»ç»“

å“åº”ç”Ÿæˆçš„æ ¸å¿ƒä½ç½®ï¼š

1. **æœ€æ ¸å¿ƒ**ï¼š`mcp_toolcall_agent.py:383-396` - OpenAI LLM ç”Ÿæˆ
2. **æå–åŒ…è£…**ï¼š`agent_orchestrator.py:123-128` - åŒ…è£…ä¸ºæ ‡å‡†æ ¼å¼
3. **SSE ä¼ è¾“**ï¼š`qa_sse.py:178-194` - æµå¼ä¼ è¾“ç»™å®¢æˆ·ç«¯

**ä¸€å¥è¯æ€»ç»“**ï¼š
å“åº”å†…å®¹ç”± **MCPToolCallAgent.act()** ä¸­çš„ OpenAI API è°ƒç”¨ç”Ÿæˆï¼ˆç¬¬ 383-388 è¡Œï¼‰ï¼Œç„¶åé€šè¿‡ agent_orchestrator å’Œ qa_sse ä¸¤å±‚åŒ…è£…åï¼Œä»¥ SSE æ ¼å¼æµå¼ä¼ è¾“ç»™å®¢æˆ·ç«¯ã€‚

